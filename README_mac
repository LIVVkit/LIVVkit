Information on how to run the Land Ice V&V (livv) Post-Processing Software.
KJE, AB, NM 2/2014

The /PISCEES/trunk/tests/higher-order/livv directory contains all the scripts and code to run livv.
The mac_VV.bash script contains the inputs needed to run on an OSX machine.
Scripts for Carver (NERSC) and Rhea (OLCF) are also provided.

Software needed for livv:

  Packages via MacPorts (versions as of 2/2014):
      1. python27
      2. py-netcdf4 @1.0.4
      3. py-numpy @1.8.0
      4. nco @4.4.0
      5. netcdf @4.3.0
      6. udunits2 @2.1.24
      7. hdf5 @1.6.9

  Packages not available via MacPorts (versions as of 2/2014):
      8. download Mac OSX NCL binary for 10.7 (instructions listed below)

      To install NCL go here:
      <http://www.earthsystemgrid.org/dataset/ncl.612.0.html>, download the latest
      Mac OSX binary for 10.7, even if you have 10.8, just pretend. Unpack it and
      move it where you want it.
      Set NCARG_ROOT to the NCL directory, and add
      $NCARG_ROOT/bin to the PATH environment variable. Best to do those in your
      .bashrc so you don't have to think about it again.

Filepaths for the python script are defined in the bash shell script, and most are required.
The command to run the python script along with all of the necessary/optional files is the last line of the script. 

/livv/bin: the python processing code 
/livv/plots: the ncl scripts 
/livv/data: the solver data from each processed run is placed here in a $case.asc format 

To run the shell script (Mac OS X):

  1. Copy the reg_test directory from http://oceans11.lanl.gov/cism/livv/ (choose the tar file with the most recent date
stamp - generally, the
     one with the "default" label is the most recent one), untar it and place in a new higher-order directory on your
mac. This will be the same
     directory as specified by TEST_DIR in the ./cmake-scripts/master_build_mac.csh file. Go ahead and copy the entire
     ./tests/higher-order/livv directory and place in this new directory as well.

  2. Now run the ./builds/mac-gnu/mac-gnu-build-and-test.csh file (see ./builds/README for more information on how to
run the csh script).

*** SFP: clarify that you do this with 'csh mac-gnu-build-and-test.csh'

     NOTE: This updated .csh file will now update your job submissions in reg_test
     to the screen and will not finish until all jobs have finished running. Thus, you can automatically run LIVV once
the jobs are finished.
     Make sure the TEST_DIR is set to the directory that you created in step #2. Also make sure the tests you want to
run
     and analyze on your machine later are selected in the csh file. The jobs in reg_test will be automatically run by
this csh
     script (as long as the path is correctly specified) after the model is successfuly built.

To set up the livv executable /higher-order/livv/mac_VV.bash:
(This can be done after you run the mac-gnu-build-and-test.csh file.)

*** SFP: Clarify that in the above, you mean that you need to edit these variable specificiations by editing
'mac_VV.bash"

  3. Change MY_PYTHON to wherever your python2.7 package exists on your mac.

*** SFP: If folks are following the mac build instructions, this will always be '/opt/local/bin/python'

  4. There is an opportunity to insert a COMMENT to display your reason for running livv on the website.

  5. Change the TEST_FILEPATH to the path containing the higher-order directory (the directory mentioned in step #1).

*** SFP: in the current version of the script, this is set to always point to TEST_DIR, which is specified above

  6. Change the HTML_PATH to the location of the www directory. If it doesn't already exist, specify the path to where
     you would like it and livv will check the path and create it if it is not already there. An example path is already
     in the bash file that you may try. If you have posted html pages from your mac previously, you can point livv to
     whatever html directory you have used and livv will create a sub-directory where it will store all of its own html
     files, therefore not disrupting the rest of your workspace.

*** SFP: as noted above, it might make sense to just specify that this goes in TEST_DIR/html (which is the default here)

  7. The verification flags are pre-set in the bash script for what will be analyzed on the mac. Note that you can
     adjust which testcases you would like livv to run within the mac_VV.bash script by changing the flag from a
     0 to 1. If you have just recently checked out the code, the flags should already be set for the tests that are
     run by the software on the machine. Mac can only run a subset of the tests due to the capacity of the machine.
     Those tests are highlighted in the mac_VV.bash script to avoid any confusion. However, you are of course
     not required to run all 6 tests that the machine processes. You are allowed to select any sub-set and combination
     of the tests. Leave RUN_ANT=0 in the mac_VV.bash script since Antarctica analysis will not be run locally.

To run livv:

  8. Type "bash mac_VV.bash" in the command line in the /higher-order/livv/ directory. When it is finished running,
     the website location will be printed to the screen where you can look at the output.
     We have piped the ncl output to a file called plot_details.out. So if there is any concern over whether plots
     have formed correctly after inspecting the website, you can look in that file.



TODOs (feel free to add to this as needed)

Major:
*create a more general user interface to process the GIS production output
*enable the option to read from FELIX data (in exodus format) using visit

Minor:
*have the input and output information from the benchmark runs set in the software rather than the user 
specify (or at least have a default)
*parse more detailed data from the output files about the solver and preconditioner
n VV_outprocess


***************************************

New, updated short-version of how-to for running / using LIVV on the Mac (SFP, 8-28-2014)

As above, you'll need to appropriate software installed. Python should already be good if you installed according to the
CISM2 instructions.

For NCL, follow the above instructions.

You'll need to set up the env variable "TEST_DIR" in both your .bashrc and .cshrc shells. Om my machine, all of my
different CISM builds live in:

/Users/sprice/work/modeling/cism/

I added a new dir there for storing test case data (model outputs, benchmark outputs, LIVV plots / webpages, etc):

/Users/sprice/work/modeling/cism/cism-test/

In there, I also added a subdir "html", where I'm going to (hopefully) see the webpages that LIVV outputs.
(It looks like LIVV is expecting to find this dir under TEST_DIR/)

In my .bashrc I added the following:
export TEST_DIR=/Users/sprice/work/modeling/cism/cism-test

And similarly in my .cshrc:
setenv TEST_DIR "/Users/sprice/work/modeling/cism/cism-test"
(note that for my .cshrc file, this is the ONLY line in there)

At this point, running Doug's "run_livv_on_mac" script from within ./tests/higher-order/livv/ works to build the code
and run the test cases. It then stops though, giving the following:

Call disabled to: mac_VV.bash, which is located in:
/Users/sprice/work/modeling/cism/cism-test/livv

Assuming that the next step would be to run mac_VV.bash, I've tried to do that manually (ideally, this would happen
automatically as part of Doug's script above, but one thing at a time). What I find is that, if I run it from
./tests/higher-order/livv/, it doesn't work. I think this is maybe NOT where it is supposed to be run from?

If I instead go to $TEST_DIR/livv/ and try to run it from there, nothing happens initially. This seems to have to do
with the if/fi construct at the bottom of the script, which is "blocking" anything from happening as far as I can tell
(at least using the simple syntax of "bash mac_VV.bash" - maybe it needs arguments?). If I comment out the if/fi lines,
so that the long ugly command there starting with
rm $HTML_PATH/livv/* runs anyway, I get the following:

08-28-2014-04:49:01 PM test run of code
rm: /Users/sprice/work/modeling/cism/cism-test/html//livv/*: No such file or directory
placing HTML files in the sprice subdirectory (check permissions)
running diagnostic dome30 glide testcase
mv: rename /Users/sprice/work/modeling/cism/cism-test/livv/plots/dome30dvel.png to
/Users/sprice/work/modeling/cism/cism-test/html/livv/dome30dvel.png: No such file or directory
Command '['mv', '-f', '/Users/sprice/work/modeling/cism/cism-test/livv/plots/dome30dvel.png',
'/Users/sprice/work/modeling/cism/cism-test/html/livv/']' returned non-zero exit status 1, File: VV_dome30details.py,
Line number: 383

Now it is finally trying to do something, but obviously struggling with the file paths for some reason.

Note that on my machine, in order to get this far, in the mac_VV.bash script, I had to change the following lines:

# set path to python version on mac
#export MY_PYTHON="/opt/local/bin/python2.7"
export MY_PYTHON="python"

Even though I've got python2.7 at that path on my machine, it doesn't work for some reason to invoke it that way. Since
I've got "python" aliased to that location anyway, I just changed MY_PYTHON to point to "python". Now at least the
python scripts are getting called.

This is as far as I got on 8/28/14.



------------- START HERE FOR NEW README INSTRUCTIONS -------------------

LIVV on the mac is mostly working as of 9/3/14. To get it working on your machine, do the following steps. Note that
after the initial setup, only steps 2 and 3 need to be done to test code before a checkin (execution of two scripts plus
looking at the webpage results at the end to make sure all is well). On my machine, the suite of tests included here 
only took a few minutes to run.


--------
step 0
--------

As above, you'll need to appropriate software installed. Python should already be good if you installed according to the
CISM2 instructions. For NCL, follow the above instructions, which worked fine for me.

  
--------
step 1
--------

You'll need to set up the env variable "TEST_DIR" in both your .bashrc and .cshrc shells. On my machine, all of my
different CISM builds live in: /Users/sprice/work/modeling/cism/

I added a new dir there for storing test case data (model outputs, benchmark outputs, LIVV plots / webpages, etc - 
essentially, this is where all the LIVV work gets done):

/Users/sprice/work/modeling/cism/cism-test/

In there, I also added a subdir "html", where the webpages that LIVV outputs get built. In the long run, we might want
to automate this in Doug's script mentioned below (i.e., make and/or clean-out the html dir automatically).

You need to point the TEST_DIR env var to this location. In my .bashrc I added the following:
export TEST_DIR=/Users/sprice/work/modeling/cism/cism-test

And similarly in my .cshrc:
setenv TEST_DIR "/Users/sprice/work/modeling/cism/cism-test"
(note that for my .cshrc file, this is the ONLY line in there)


--------
step 2
--------

At this point, running Doug's "run_livv_on_mac" script from within ./tests/higher-order/livv/ works to build the code
and run the test cases. This should build the exectuables to test from your current code, wget the current reg_test
tarball from oceans11, and run the various tests we've specified for the mac version of livv. My output looks like this:

>>>>>>
Running LIVV test suite on a Mac.

To run tests without rebuilding, use skip-build.


To use this script, type: csh mac-gnu-build-and-test.csh


Call with no-copy to prevent copying of the reg_test and livv defaults.
Call with run-perf-tests to run the performance tests.
Call with skip-tests to skip testing (builds executable and copies it to TEST_DIR).

See the LIVV documentation for instructions on setting up the test directory (TEST_DIR).


Setting TEST_DIR to the location: 
TEST_DIR = /Users/sprice/work/modeling/cism/cism-test
TEST_DIR must also be set in your .bashrc file.

Configuring and building in directory:  /Users/sprice/work/modeling/cism/temp/builds/mac-gnu

Configuring gnu cmake build...
Making parallel gnu...
Copying gnu parallel cism_driver_gnu to test directory
Copying default reg_test and LIVV to ~/work/modeling/cism/cism-test
--2014-09-03 20:04:01--  http://oceans11.lanl.gov/cism/livv/reg_test_default.tgz
Resolving oceans11.lanl.gov (oceans11.lanl.gov)... 204.121.60.121
Connecting to oceans11.lanl.gov (oceans11.lanl.gov)|204.121.60.121|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 33155591 (32M) [application/x-gzip]
Saving to: ‘reg_test_default.tgz’

100%[=========================================================================================================================================>]
33,155,591   424KB/s   in 74s    

2014-09-03 20:05:20 (436 KB/s) - ‘reg_test_default.tgz’ saved [33155591/33155591]

Submitting default LIVV test jobs to compute nodes.

GLISSADE 1 proc

real    0m3.056s
user    0m2.752s
sys 0m0.061s
GLISSADE 4 proc

real    0m2.541s
user    0m5.223s
sys 0m1.206s
GLISSADE 1 proc

... lots more like this, the finishing with ...

No performance suite jobs were submitted.
Total minutes: 0

Call disabled to: mac_VV.bash, which is located in:
/Users/sprice/work/modeling/cism/cism-test/livv

Perform this step on after the Test Suite jobs have completed.
>>>>>>>>>

At this point, your TEST_DIR should have more stuff in it. Mine looks like this:

>>>>>>>>>
-rwx------+  1 sprice  staff   2446712 Sep  3 20:04 cism_driver_gnu*
drwx------+  3 sprice  staff       102 Sep  3 20:13 html/
drwx------+ 19 sprice  staff       646 Sep  3 20:13 livv/
drwx------@ 11 sprice  staff       374 Sep  3 20:05 reg_test/
-rw-r--r--+  1 sprice  staff  33155591 Sep  3 18:34 reg_test_default.tgz
-rwx------+  1 sprice  staff   2446712 Sep  3 20:04 simple_glide_gnu*
>>>>>>>>>

(when we started, it was empty aside from an empty 'html' subdir)

 
--------
step 3
--------

Run the actual livv part of the code, which compares your recent model outputs to those from the benchmarks stored in
the reg_test tarball that was downloaded.

To do this, you simply go into the TEST_DIR/livv/ dir and execute the bash script 'mac_VV.bash'. Here's my output:

>>>>>>>
./mac_VV.bash 
./mac_VV.bash: line 66: ((: == 1: syntax error: operand expected (error token is "== 1")
09-03-2014-08:13:14 PM Test run of glissade code
placing HTML files in the sprice subdirectory (check permissions)
running diagnostic dome30 glissade testcase
running evolving dome30 glissade testcase
running circular shelf glissade testcase
running confined shelf glissade testcase
running ismip hom a 80km glissade testcase
running ismip hom a 20km glissade testcase
NOT RUNNING ISMIP HOM C 80KM TESTCASE
NOT RUNNING ISMIP HOM C 20KM TESTCASE
LIVV Completed. Go to file:///Users/sprice/work/modeling/cism/cism-test/html/livv/livv_kit_main.html to view results
>>>>>>>

Not sure what the "line 66" error is but it doesn't seem to affect things much.

The URL where the results are is in your TEST_DIR/html/ subdir under ./livv. This is where you can view the comparison
results of your model output relative to the benchmarks.

Note that we'll need to fix some of the python scripts so that the ismip-hom c tests can be compared. Right now, the
benchmarks are in the reg_test tarball, the tests are being run, but the results aren't being compared.


9/3/2014



Problems related to NCL installation on my Mac.   MJH 9/4/14
Note that detailed information on installing NCL for Mac is here:  https://www.ncl.ucar.edu/Download/macosx.shtml
For older versions of OSX, you may need to find an older version of NCL for NCL to work.  For instance, for Snow Leopard (10.6.8) the most recent version of NCL I could get to work was 6.1.2.  
Even then, I was seeing this error:
dyld: lazy symbol binding failed: Symbol not found: ___emutls_get_address
 Referenced from: /usr/local/bin/ncl
 Expected in: /usr/lib/libSystem.B.dylib
Looking at the above URL with installation instructions, I was able to resolve this error by adding this to my .bashrc:
export DYLD_FALLBACK_LIBRARY_PATH=/opt/local/lib/gcc46


